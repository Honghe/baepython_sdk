# -*- coding: utf-8 -*-

from django.shortcuts import get_object_or_404, render_to_response
from django.http import HttpResponseRedirect, HttpResponse
from django.core.urlresolvers import reverse
from django.template import RequestContext
from django.shortcuts import render


def index(request):
    return render(request, 'upload/index.html', {})

BCS_HOST="http://bcs.duapp.com"
def upload(request):
    uf = request.FILES.get('file', None)
    data = uf.read()
    name = uf.name
    size = uf.size

    from bae.api.bcs import BaeBCS
    bcs = BaeBCS(host=BCS_HOST)
    bname = "pyupload"

    import hashlib
    oname = hashlib.md5(data).hexdigest().encode('utf8')
    ##return HttpResponse("try to upload %s" % oname)
    ###oname = "/%s" % name.encode('utf8')
    e, d = bcs.put_object(bname, oname, data)
    if e != 0:
        s = "put_object failed: " + str(d)
        return HttpResponse(s)

    e, d = bcs.make_public(bname, oname)
    if e != 0:
        s = "make_public failed: " + str(d)
        return HttpResponse(s)

    new_url = "%s/%s/%s" % (BCS_HOST, bname, oname)
    return HttpResponse("new URL is %s" % new_url)
    return HttpResponseRedirect(new_url)
    #return HttpResponse(s)
